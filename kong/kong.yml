# kong/kong.yml (updated)
_format_version: "3.0"
services:
  - name: user-service
    url: http://user-service:3003
    routes:
      # Auth routes (public)
      - name: user-auth-routes
        paths:
          - /api/auth/register
          - /api/auth/login
          - /api/auth/refresh
        strip_path: false
        plugins:
          - name: crypto-decrypt   # decrypt only for register/login

      # Auth logout (authenticated only)
      - name: user-auth-logout
        strip_path: false
        paths:
          - /api/auth/logout
        plugins:
          - name: user-auth-token-handler
          # Basic auth only, no RBAC needed

      # User profile routes (user can access own, admin can access all)
      - name: user-profile-own
        strip_path: false
        paths:
          - /api/profiles/me
          - /api/users/me
        plugins:
          - name: user-auth-token-handler
          # Just authentication, users can access their own data

      # Admin profile management
      - name: user-profile-admin
        strip_path: false
        paths:
          - /api/profiles/users
          - /api/users/[0-9a-f-]+$  # UUID pattern
        plugins:
          - name: user-auth-token-handler
            config:
              required_roles: ["admin", "super_admin"]
              owner_param: "userId"  # Allow owner access too

      # Role management (admin only)
      - name: user-role-management
        strip_path: false
        paths:
          - /api/roles
        plugins:
          - name: user-auth-token-handler
            config:
              required_roles: ["admin", "super_admin"]

      # User own roles (authenticated users)
      - name: user-own-roles
        strip_path: false
        paths:
          - /api/user/roles
        plugins:
          - name: user-auth-token-handler
          # Just authentication needed

      # Internal routes (for Kong only)
      - name: user-internal-routes
        strip_path: false
        paths:
          - /api/internal
        plugins:
          - name: user-auth-token-handler
            config:
              allow_public: true  # Internal service auth handled in application

  - name: product-service
    url: http://product-service:3004
    routes:
      # Public product browsing
      - name: product-public
        paths:
          - /api/product
          - /api/categories
        strip_path: false
        plugins:
          - name: user-auth-token-handler
            config:
              allow_public: true

      # Product management (admin/moderator only)
      - name: product-management
        paths:
          - /api/product/manage
          - /api/categories/manage
        strip_path: false
        plugins:
          - name: user-auth-token-handler
            config:
              required_permissions: ["product:create", "product:update", "product:delete"]

      # User's own orders
      - name: user-orders
        paths:
          - /api/orders/me
        strip_path: false
        plugins:
          - name: user-auth-token-handler
            config:
              required_permissions: ["order:read", "order:create"]

      # Order management (admin only)
      - name: order-management
        paths:
          - /api/orders/manage
        strip_path: false
        plugins:
          - name: user-auth-token-handler
            config:
              required_roles: ["admin", "super_admin"]

  - name: shopping-cart-service
    url: http://shopping-cart-service:3005
    routes:
      # Cart management (authenticated users only)
      - name: cart-routes
        paths:
          - /api/cart
        strip_path: false
        plugins:
          - name: user-auth-token-handler
            config:
              allow_public: true

  - name: store-service
    url: http://store-service:3006
    routes:
      # Health check (public)
      - name: store-health
        paths:
          - /api/health
        strip_path: false
        plugins:
          - name: user-auth-token-handler
            config:
              allow_public: true

      # Store management (authenticated users)
      - name: store-management
        paths:
          - /api/stores
        strip_path: false
        methods:
          - POST
          - GET
        plugins:
          - name: user-auth-token-handler
          # Any authenticated user can create stores and view their own stores

      # Store access by ID or slug (store members only)
      - name: store-access
        paths:
          - ~/api/stores/[0-9a-f-]+$
          - ~/api/stores/slug/
        strip_path: false
        methods:
          - GET
        plugins:
          - name: user-auth-token-handler
          # Store member validation happens in service

      # Store updates and deletion (store admin/owner only)
      - name: store-modify
        paths:
          - ~/api/stores/[0-9a-f-]+$
        strip_path: false
        methods:
          - PUT
          - DELETE
        plugins:
          - name: user-auth-token-handler
          # Permission validation happens in service based on store roles

      # Member invitation (store admin/owner only)
      - name: store-invite
        paths:
          - ~/api/stores/[0-9a-f-]+/invite$
        strip_path: false
        methods:
          - POST
        plugins:
          - name: user-auth-token-handler
          # Permission validation happens in service

      # Member management (store members can view, admin/owner can manage)
      - name: store-members
        paths:
          - ~/api/stores/[0-9a-f-]+/members
          - ~/api/stores/[0-9a-f-]+/invitations
        strip_path: false
        methods:
          - GET
        plugins:
          - name: user-auth-token-handler
          # Permission validation happens in service

      # Member role updates and removal (store admin/owner only)
      - name: store-member-management
        paths:
          - ~/api/stores/[0-9a-f-]+/members/[0-9a-f-]+/role$
          - ~/api/stores/[0-9a-f-]+/members/[0-9a-f-]+$
        strip_path: false
        methods:
          - PUT
          - DELETE
        plugins:
          - name: user-auth-token-handler
          # Permission validation happens in service

      # Get user invitations (authenticated users)
      - name: store-user-invitations
        paths:
          - /api/invitations
        strip_path: false
        methods:
          - GET
        plugins:
          - name: user-auth-token-handler
          # Any authenticated user can view their invitations

      # Accept invitation (authenticated users)
      - name: store-invitation-accept
        paths:
          - /api/invitations/accept
        strip_path: false
        methods:
          - POST
        plugins:
          - name: user-auth-token-handler
          # Any authenticated user can accept invitations sent to them

# Example usage for different access patterns:
# 1. Public access: allow_public: true
# 2. Admin only: required_roles: ["admin", "super_admin"]
# 3. Permission-based: required_permissions: ["product:create", "user:update"]
# 4. Owner or admin: required_roles: ["admin"] + owner_param: "userId"
# 5. Multiple roles: required_roles: ["admin", "moderator", "customer"]