services:
  kong:
    build:
      context: ./kong
      dockerfile: Dockerfile
    container_name: kong
    restart: always
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong.yml
      KONG_PROXY_LISTEN: "0.0.0.0:3000"
      KONG_LOG_LEVEL: debug
    ports:
      - "3000:3000" # Public API gateway
      - "3001:3001" # Admin API
    volumes:
      - ./kong/kong.yml:/etc/kong/kong.yml
      - ./kong/kong.conf:/etc/kong/kong.conf
    networks:
      - public-net
      - internal-net
    depends_on:
      - crypto-service
      - user-service
      - product-service

  crypto-service:
    build:
      context: ./crypto-service
      dockerfile: Dockerfile
    container_name: crypto-service
    expose:
      - 3002
    env_file:
      - ./crypto-service/.env
    networks:
      - internal-net

  # -------------------------
  # Product Service
  # -------------------------
  product-service:
    build: ./product-service
    env_file: ./product-service/.env.product
    networks:
      - internal-net
    expose:
      - 3004
    depends_on:
      - product-db
      - product-redis

  product-db:
    image: postgres:16-alpine
    container_name: product-db
    env_file: ./product-service/.env.product
    volumes:
      - product-db-data:/var/lib/postgresql/data
    networks:
      - internal-net
    expose:
      - 5432

  product-redis:
    image: redis:7-alpine
    container_name: product-redis
    env_file: ./product-service/.env.product
    networks:
      - internal-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      sh -c "
        if [ -n '${REDIS_PASSWORD}' ]; then
          redis-server --requirepass '${REDIS_PASSWORD}'
        else
          redis-server
        fi
      "
    expose:
      - 6379

  # -------------------------
  # User Service
  # -------------------------
  user-service:
    build: ./user-service
    env_file: ./user-service/.env.user
    networks:
      - internal-net
    expose:
      - 3003
    depends_on:
      - user-db
      - user-redis

  user-db:
    image: postgres:16-alpine
    container_name: user-db
    env_file: ./user-service/.env.user
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      - internal-net
    expose:
      - 5432

  user-redis:
    image: redis:7-alpine
    container_name: user-redis
    env_file: ./user-service/.env.user
    networks:
      - internal-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      sh -c "
        if [ -n '${REDIS_PASSWORD}' ]; then
          redis-server --requirepass '${REDIS_PASSWORD}'
        else
          redis-server
        fi
      "
    expose:
      - 6379

  # -------------------------
  # Shopping Cart Service
  # -------------------------
  shopping-cart-service:
    build: ./shopping-cart-service
    env_file: ./shopping-cart-service/.env.cart
    networks:
      - internal-net
    expose:
      - 3005
    depends_on:
      - cart-db
      - cart-redis
      - product-service

  cart-db:
    image: postgres:16-alpine
    container_name: cart-db
    env_file: ./shopping-cart-service/.env.cart
    volumes:
      - cart-db-data:/var/lib/postgresql/data
    networks:
      - internal-net
    expose:
      - 5432

  cart-redis:
    image: redis:7-alpine
    container_name: cart-redis
    env_file: ./shopping-cart-service/.env.cart
    networks:
      - internal-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      sh -c "
        if [ -n '${REDIS_PASSWORD}' ]; then
          redis-server --requirepass '${REDIS_PASSWORD}'
        else
          redis-server
        fi
      "
    expose:
      - 6379

volumes:
  user-db-data:
  product-db-data:
  cart-db-data:

networks:
  public-net:   # exposed to host
  internal-net: # private between services